variables:
  NODE_OPTIONS: '--max_old_space_size=4096'

stages:
  - build
  - deploy

# Note: Skip main merge build to save Gitlab cloud Compute Minutes
# platform-merge-build:
#   image: node:18.15.0
#   stage: build
#   rules:
#     - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
#   script:
#     - npm install -g pnpm
#     - pnpm i
#     - npm run test
#     - cd ./projects/platform
#     - npm run build --mode=development

platform-build:
  image: node:18.15.0
  stage: build
  rules:
    - if: $CI_COMMIT_REF_NAME == "main"
      variables:
        DEPLOY_ENV: 'development'
    - if: $CI_COMMIT_REF_NAME == "staging"
      variables:
        DEPLOY_ENV: 'staging'
    - if: $CI_COMMIT_REF_NAME == "feat"
      variables:
        DEPLOY_ENV: 'feat'
    - if: $CI_COMMIT_REF_NAME == "pre-production"
      variables:
        DEPLOY_ENV: 'pre-production'
    - if: $CI_COMMIT_TAG
      variables:
        DEPLOY_ENV: 'production'
  script:
    - npm install -g pnpm
    - pnpm i
    - npm run test
    #- if [ "$DEPLOY_ENV" == "pre-production" ]; then npm run e2e --mode=pre-production; fi
    - cd ./projects/platform
    - npm run build --mode=$DEPLOY_ENV
  artifacts:
    paths:
      - projects/platform/dist/

platform-deploy-to-dev:
  image: registry.gitlab.com/gitlab-org/cloud-deploy/aws-base:latest
  stage: deploy
  only:
    refs:
      - main
  script:
    - cd ./projects/platform
    - bash ./scripts/deploy.sh development

platform-deploy-to-staging:
  image: registry.gitlab.com/gitlab-org/cloud-deploy/aws-base:latest
  stage: deploy
  only:
    refs:
      - staging
  script:
    - cd ./projects/platform
    - bash ./scripts/deploy.sh staging

platform-deploy-to-feat:
  image: registry.gitlab.com/gitlab-org/cloud-deploy/aws-base:latest
  stage: deploy
  only:
    refs:
      - feat
  script:
    - cd ./projects/platform
    - bash ./scripts/deploy.sh feat

platform-deploy-to-pre-production:
  image: registry.gitlab.com/gitlab-org/cloud-deploy/aws-base:latest
  stage: deploy
  only:
    refs:
      - pre-production
  script:
    - cd ./projects/platform
    - bash ./scripts/deploy.sh pre-production

platform-deploy-to-prod:
  image: registry.gitlab.com/gitlab-org/cloud-deploy/aws-base:latest
  stage: deploy
  only:
    refs:
      - tags
  script:
    - export VITE_APP_AG_GRID_LICENSE_KEY_BASE64_ENCODED=$AG_GRID_LICENSE_KEY_BASE64_ENCODED
    - cd ./projects/platform
    - bash ./scripts/deploy.sh production

storybook-build:
  stage: build
  image: node:18.15.0
  only:
    refs:
      - main
    changes:
      - packages/ui-component/**/*
  script:
    - npm install -g pnpm
    - pnpm i
    - cd ./packages/ui-component
    - npm run build
  artifacts:
    paths:
      - packages/ui-component/storybook-static/

storybook-deploy:
  stage: deploy
  image: registry.gitlab.com/gitlab-org/cloud-deploy/aws-base:latest
  only:
    refs:
      - main
    changes:
      - packages/ui-component/**/*
  script:
    - cd ./packages/ui-component
    - bash ./deploy.sh
