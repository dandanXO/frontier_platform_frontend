stages:
  - build
  - deploy

platform-build:
  image: node:18.15.0
  stage: build
  rules:
    - if: $CI_COMMIT_REF_NAME == "main"
      variables:
        DEPLOY_ENV: 'development'
    - if: $CI_COMMIT_TAG
      variables:
        DEPLOY_ENV: 'production'
  script:
    - npm install -g pnpm
    - pnpm i
    - cd ./projects/platform
    - npm run build --mode=$DEPLOY_ENV
  artifacts:
    paths:
      - projects/platform/dist/

platform-deploy-to-dev:
  image: registry.gitlab.com/gitlab-org/cloud-deploy/aws-base:latest
  stage: deploy
  only:
    refs:
      - main
  script:
    - cd ./projects/platform
    - bash ./scripts/deploy.sh development

platform-deploy-to-prod:
  image: registry.gitlab.com/gitlab-org/cloud-deploy/aws-base:latest
  stage: deploy
  only:
    refs:
      - tags
  script:
    - cd ./projects/platform
    - bash ./scripts/deploy.sh production

storybook-build:
  stage: build
  image: node:18.15.0
  only:
    refs:
      - main
    changes:
      - packages/ui-component/**/*
  script:
    - npm install -g pnpm
    - pnpm i
    - cd ./packages/ui-component
    - npm run build
  artifacts:
    paths:
      - packages/ui-component/storybook-static/

storybook-deploy:
  stage: deploy
  image: registry.gitlab.com/gitlab-org/cloud-deploy/aws-base:latest
  only:
    refs:
      - main
    changes:
      - packages/ui-component/**/*
  script:
    - cd ./packages/ui-component
    - bash ./deploy.sh
