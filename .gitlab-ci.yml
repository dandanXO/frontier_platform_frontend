stages:
  - build
  - deploy

.platform:
  only:
    refs:
      - main
      - /^hotfix\/.*$/
      - /^release\/.*$/
      - develop
    changes:
      - packages/**/*
      - projects/platform/**/*
  before_script:
    - >
      if [[ "$CI_COMMIT_REF_NAME" == "main" ]]; then
        TARGET_ENV="production"
      elif [[ "$CI_COMMIT_REF_NAME" =~ "hotfix/" ]]; then
        TARGET_ENV="pre-production"
      elif [[ "$CI_COMMIT_REF_NAME" =~ "release/" ]]; then
        TARGET_ENV="staging"
      elif [[ "$CI_COMMIT_REF_NAME" == "develop" ]]; then
        TARGET_ENV="development"
      fi

platform-build:
  extends: .platform
  stage: build
  image: node:16.13.2
  script:
    - echo $TARGET_ENV
    - npm install -g pnpm
    - pnpm i
    - cd ./projects/platform
    - npm run build --mode=$TARGET_ENV
  artifacts:
    paths:
      - projects/platform/dist/

platform-deploy:
  extends: .platform
  stage: deploy
  image: registry.gitlab.com/gitlab-org/cloud-deploy/aws-base:latest
  script:
    - echo $TARGET_ENV
    - cd ./projects/platform
    - bash ./scripts/deploy.sh $TARGET_ENV

storybook-build:
  stage: build
  image: node:16.13.2
  only:
    changes:
      - packages/ui-component/**/*
  script:
    - npm install -g pnpm
    - pnpm i
    - cd ./packages/ui-component
    - npm run build
  artifacts:
    paths:
      - packages/ui-component/storybook-static/

storybook-deploy:
  stage: deploy
  image: registry.gitlab.com/gitlab-org/cloud-deploy/aws-base:latest
  only:
    changes:
      - packages/ui-component/**/*
  script:
    - cd ./packages/ui-component
    - bash ./deploy.sh
